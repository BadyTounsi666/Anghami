const electron=require("electron"),path=require("path"),app=electron.app,Tray=electron.Tray,Menu=electron.Menu,iconsPath=path.join(__dirname,"..","..","assets","icons"),isMac="darwin"===process.platform,ipcMain=require("electron").ipcMain,log=require("electron-log");let tray,trayReady=!1,alwaysOnTop=!1,initTray=(e,t)=>{let a=new Menu,i=[{label:"Play/Pause",type:"normal",click:emitPlayEvent,enabled:!0},{label:"Next",type:"normal",click:emitNextEvent,enabled:!0},{label:"Previous",type:"normal",click:emitPreviousEvent,enabled:!0},{type:"separator"},{label:"Quit",type:"normal",click:app.quit}];a=Menu.buildFromTemplate(i),isMac?tray=new Tray(path.join(iconsPath,"trayIconTemplate.png")):(tray=new Tray(path.join(iconsPath,"IconAnghami.ico"))).setContextMenu(a),tray.setToolTip("Anghami"),tray.setIgnoreDoubleClickEvents(!0),ipcMain.on("miniplayerSwitch",(a,i)=>{if(log.log("[Tray main process] On miniplayerSwitch received"+trayReady),trayReady){let a=0;global.isMiniPlayer=!0,alwaysOnTop=i.value,t.isFullScreen()&&(t.setFullScreen(!1),a=1e3),setTimeout(()=>{t.hide(),showTray(e)},a)}}),ipcMain.on("trayReady",(e,t)=>{trayReady||log.log("[Tray main process] On trayReady received "+t.trayReady),trayReady=t.trayReady}),tray.on("click",t=>{global.isMiniPlayer?(e.isMinimized()&&e.restore(),e.focus()):e.isVisible()?e.hide():trayReady&&showTray(e)}),e.on("blur",t=>{!global.isMiniPlayer&&e.isVisible()&&e.hide()})},showTray=e=>{const t=electron.screen.getPrimaryDisplay().size;let a,i;e.setMinimumSize(350,500),e.setSize(350,500);const n=e.getBounds(),o=tray.getBounds();if(global.isMiniPlayer)e.setSkipTaskbar(!1),alwaysOnTop?e.setAlwaysOnTop(!0):e.setAlwaysOnTop(!1),a=Math.round(t.width/2-n.width/2),i=Math.round(t.height/2-n.height/2),e.webContents.send("tray-position",{isMiniPlayer:!0});else{e.setSkipTaskbar(!0),e.setAlwaysOnTop(!0);let r=1,s="top";(a=Math.round(o.x+o.width/2-n.width/2))+n.width>t.width?(a=Math.round(t.width-n.width-0),r=0):a<0&&(a=0,r=0),o.y<t.height/2?(i=Math.round(o.y+o.height+0),s="top"):(i=Math.round(o.y-n.height-0),s="bottom"),e.webContents.send("tray-position",{showArrow:r,side:s,isMiniPlayer:!1})}emitTrayOpenedEvent(),e.setOpacity(0),e.show(),e.setPosition(a,i,!1),e.removeMenu(),setTimeout(()=>{e.setOpacity(1)},50),e.setVisibleOnAllWorkspaces(!0,{})};function emitPlayEvent(){emitMessageToWebPlayer("shortcuts-player-action",{action:"playpause"})}function emitNextEvent(){emitMessageToWebPlayer("shortcuts-player-action",{action:"next"})}function emitPreviousEvent(){emitMessageToWebPlayer("shortcuts-player-action",{action:"previous"})}function emitTrayOpenedEvent(){emitMessageToWebPlayer("tray-opened",{})}function emitMessageToWebPlayer(e,t={}){global.emitMessageToWebPlayer(e,t)}module.exports=initTray;